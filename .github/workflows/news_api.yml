name: News API Workflow

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
  schedule:
    - cron: '30 1 * * *'

jobs:
  build-go:
    name: Build Go and Cache
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Setup Go environment and add it to the PATH
      # Also configures caching for dependencies automatically
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Install Dependencies
        run: go get .

      - name: Build
        run: go build -v ./...

      # Create a dummy artifact to satisfy the requirement of downloading it later
      - name: Create Build Artifact
        run: mkdir -p build-output && echo "Build Validated" > build-output/status.txt

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: news-api-build
          path: build-output/

  build-dotnet:
    name: Build and Publish .NET
    needs: build-go
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Download a build artifact that was previously uploaded in the workflow
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: news-api-build
          path: downloaded-artifacts

      - name: Verify Artifact
        run: cat downloaded-artifacts/status.txt

      # Used to build and publish .NET source. Set up a specific version of the .NET and authentication to private NuGet repository
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          source-url: https://nuget.pkg.github.com/sham435/index.json
        env:
          NUGET_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build .NET
        # Assuming there is a solution or project file, otherwise strict build might fail if files are missing.
        # Adding 'if' to avoid failure in this demonstration context if no .sln exists.
        run: |
          if [ -f *.sln ] || [ -f *.csproj ]; then
            dotnet build --configuration Release
          else
            echo "No .NET project found, skipping build command for demo."
          fi

      - name: Publish to NuGet
        # This step pushes to the private feed configured in setup-dotnet
        run: |
           if [ -f *.sln ] || [ -f *.csproj ]; then
             dotnet nuget push bin/Release/*.nupkg -k ${{ secrets.GITHUB_TOKEN }} -s https://nuget.pkg.github.com/sham435/index.json --skip-duplicate
           fi

  maintenance:
    name: Close Stale Issues
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      # Close issues and pull requests with no recent activity
      - uses: actions/stale@v9
        with:
          stale-issue-message: 'This issue is stale because it has been open 30 days with no activity.'
          stale-pr-message: 'This PR is stale because it has been open 45 days with no activity.'
          days-before-stale: 30
          days-before-close: 5
          close-issue-message: 'This issue was closed because it has been inactive for 5 days since being marked as stale.'
