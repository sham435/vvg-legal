name: 100% Working Stack - Master Orchestrator

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Deployment mode'
        required: true
        default: 'setup'
        type: choice
        options:
          - setup
          - verify
          - fix
          - reset
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'

jobs:
  setup-phase-1-infrastructure:
    name: 'Phase 1: Infrastructure Setup'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Verify Railway Project
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üîß Phase 1: Setting up infrastructure..."
          
          cd backend
          
          # Verify project is linked
          PROJECT=$(railway project 2>/dev/null || echo "not-linked")
          if [ "$PROJECT" = "not-linked" ]; then
            echo "‚ùå Railway project not linked"
            echo "Run locally: cd backend && railway link"
            exit 1
          fi
          
          echo "‚úÖ Railway project linked"
          
          # Get service info
          DOMAIN=$(railway domain 2>/dev/null || echo "")
          if [ -n "$DOMAIN" ]; then
            echo "‚úÖ Domain configured: https://$DOMAIN"
          else
            echo "‚ö†Ô∏è Domain not yet configured"
          fi

      - name: Provision Database
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üóÑÔ∏è Checking database..."
          
          cd backend
          
          DB_URL=$(railway variables get DATABASE_URL 2>/dev/null || echo "")
          if [ -z "$DB_URL" ]; then
            echo "‚ö†Ô∏è PostgreSQL not yet provisioned"
            echo "üí° Add PostgreSQL in Railway Dashboard"
            echo "   Railway will auto-set DATABASE_URL"
          else
            echo "‚úÖ PostgreSQL configured"
          fi

      - name: Provision Redis
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üîÑ Checking Redis..."
          
          cd backend
          
          REDIS_URL=$(railway variables get REDIS_URL 2>/dev/null || echo "")
          if [ -z "$REDIS_URL" ]; then
            echo "‚ö†Ô∏è Redis not yet provisioned"
            echo "üí° Add Redis in Railway Dashboard"
            echo "   Railway will auto-set REDIS_URL"
          else
            echo "‚úÖ Redis configured"
          fi

  setup-phase-2-security:
    name: 'Phase 2: Security Configuration'
    runs-on: ubuntu-latest
    needs: setup-phase-1-infrastructure
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Generate and Set Secrets
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üîê Phase 2: Configuring security..."
          
          cd backend
          
          generate_secret() {
            openssl rand -base64 32
          }
          
          # JWT_SECRET
          JWT_CURRENT=$(railway variables get JWT_SECRET 2>/dev/null || echo "")
          if [ -z "$JWT_CURRENT" ] || [ ${#JWT_CURRENT} -lt 32 ]; then
            echo "üîß Setting JWT_SECRET..."
            railway variables set JWT_SECRET="$(generate_secret)"
          fi
          echo "‚úÖ JWT_SECRET: configured"
          
          # VVG_JWT_SECRET
          VVG_JWT_CURRENT=$(railway variables get VVG_JWT_SECRET 2>/dev/null || echo "")
          if [ -z "$VVG_JWT_CURRENT" ] || [ ${#VVG_JWT_CURRENT} -lt 32 ]; then
            echo "üîß Setting VVG_JWT_SECRET..."
            railway variables set VVG_JWT_SECRET="$(generate_secret)"
          fi
          echo "‚úÖ VVG_JWT_SECRET: configured"
          
          # INTERNAL_API_SECRET
          INTERNAL_CURRENT=$(railway variables get INTERNAL_API_SECRET 2>/dev/null || echo "")
          if [ -z "$INTERNAL_CURRENT" ] || [ ${#INTERNAL_CURRENT} -lt 32 ]; then
            echo "üîß Setting INTERNAL_API_SECRET..."
            railway variables set INTERNAL_API_SECRET="$(generate_secret)"
          fi
          echo "‚úÖ INTERNAL_API_SECRET: configured"
          
          # API_KEY_SALT
          SALT_CURRENT=$(railway variables get API_KEY_SALT 2>/dev/null || echo "")
          if [ -z "$SALT_CURRENT" ]; then
            echo "üîß Setting API_KEY_SALT..."
            railway variables set API_KEY_SALT="$(generate_secret)"
          fi
          echo "‚úÖ API_KEY_SALT: configured"

  setup-phase-3-api-keys:
    name: 'Phase 3: API Keys Configuration'
    runs-on: ubuntu-latest
    needs: setup-phase-2-security
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Check and Configure API Keys
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üîë Phase 3: Checking API keys..."
          
          cd backend
          
          MISSING_KEYS=""
          
          # NewsAPI
          NEWS_KEY=$(railway variables get NEWS_API_KEY 2>/dev/null || echo "")
          if [ -z "$NEWS_KEY" ] || [ "$NEWS_KEY" = "your_"* ]; then
            echo "‚ùå NEWS_API_KEY: MISSING"
            echo "   Get free key: https://newsapi.org/register"
            MISSING_KEYS="$MISSING_KEYS NEWS_API_KEY"
          else
            echo "‚úÖ NEWS_API_KEY: configured"
          fi
          
          # OpenAI
          OPENAI_KEY=$(railway variables get OPENAI_API_KEY 2>/dev/null || echo "")
          if [ -z "$OPENAI_KEY" ] || [ "$OPENAI_KEY" = "your_"* ] || [ "$OPENAI_KEY" = "sk-your_"* ]; then
            echo "‚ùå OPENAI_API_KEY: MISSING"
            echo "   Get key: https://platform.openai.com/api-keys"
            MISSING_KEYS="$MISSING_KEYS OPENAI_API_KEY"
          else
            echo "‚úÖ OPENAI_API_KEY: configured"
          fi
          
          # Video Generation (Luma or Runway)
          LUMA_KEY=$(railway variables get LUMA_API_KEY 2>/dev/null || echo "")
          RUNWAY_KEY=$(railway variables get RUNWAY_API_KEY 2>/dev/null || echo "")
          
          if [ -z "$LUMA_KEY" ] && [ -z "$RUNWAY_KEY" ]; then
            echo "‚ùå VIDEO_GENERATION: MISSING"
            echo "   Set LUMA_API_KEY or RUNWAY_API_KEY"
            echo "   Luma: https://lumalabs.ai/ (~$0.50/video)"
            MISSING_KEYS="$MISSING_KEYS VIDEO_GENERATION"
          else
            echo "‚úÖ Video generation: configured"
          fi
          
          if [ -n "$MISSING_KEYS" ]; then
            echo ""
            echo "‚ö†Ô∏è MISSING KEYS:$MISSING_KEYS"
            echo ""
            echo "Set them manually:"
            echo "  cd backend"
            echo "  railway variables set KEY_NAME='key-value'"
            exit 1
          fi

  setup-phase-4-youtube:
    name: 'Phase 4: YouTube Integration'
    runs-on: ubuntu-latest
    needs: setup-phase-3-api-keys
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Configure YouTube
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üì∫ Phase 4: Checking YouTube integration..."
          
          cd backend
          
          YT_CLIENT=$(railway variables get YOUTUBE_CLIENT_ID 2>/dev/null || echo "")
          YT_SECRET=$(railway variables get YOUTUBE_CLIENT_SECRET 2>/dev/null || echo "")
          YT_TOKEN=$(railway variables get YOUTUBE_REFRESH_TOKEN 2>/dev/null || echo "")
          YT_CHANNEL=$(railway variables get YOUTUBE_CHANNEL_ID 2>/dev/null || echo "")
          
          if [ -z "$YT_CLIENT" ] || [ -z "$YT_SECRET" ] || [ -z "$YT_TOKEN" ]; then
            echo "‚ùå YouTube OAuth: INCOMPLETE"
            echo ""
            echo "Setup instructions:"
            echo "1. Go to https://console.cloud.google.com/apis/credentials"
            echo "2. Create OAuth2 credentials (Web application)"
            echo "3. Add redirect URI:"
            DOMAIN=$(railway domain 2>/dev/null || echo "your-domain.up.railway.app")
            echo "   https://$DOMAIN/auth/youtube/callback"
            echo "4. Get refresh token using backend/scripts/get-youtube-token.js"
            echo "5. Set variables:"
            echo "   railway variables set YOUTUBE_CLIENT_ID='...'"
            echo "   railway variables set YOUTUBE_CLIENT_SECRET='...'"
            echo "   railway variables set YOUTUBE_REFRESH_TOKEN='...'"
            echo "   railway variables set YOUTUBE_CHANNEL_ID='...'"
            exit 1
          else
            echo "‚úÖ YouTube OAuth: configured"
          fi

  setup-phase-5-automation:
    name: 'Phase 5: Enable Automation'
    runs-on: ubuntu-latest
    needs: setup-phase-4-youtube
    steps:
      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Enable Automatic Publishing
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "‚öôÔ∏è Phase 5: Enabling automatic publishing..."
          
          cd backend
          
          # Enable auto-generation
          railway variables set ENABLE_AUTO_GENERATION="true"
          echo "‚úÖ ENABLE_AUTO_GENERATION: true"
          
          # Set generation interval
          railway variables set GENERATION_INTERVAL_HOURS="1"
          echo "‚úÖ GENERATION_INTERVAL_HOURS: 1"
          
          # Disable manual approval
          railway variables set REQUIRE_MANUAL_APPROVAL="false"
          echo "‚úÖ REQUIRE_MANUAL_APPROVAL: false"
          
          # Set production mode
          railway variables set NODE_ENV="production"
          echo "‚úÖ NODE_ENV: production"
          
          # Set port
          railway variables set PORT="3000"
          echo "‚úÖ PORT: 3000"
          
          # Set log level
          railway variables set LOG_LEVEL="info"
          echo "‚úÖ LOG_LEVEL: info"

  setup-phase-6-deploy:
    name: 'Phase 6: Deploy & Verify'
    runs-on: ubuntu-latest
    needs: setup-phase-5-automation
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Build & Deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üöÄ Phase 6: Building and deploying..."
          
          cd backend
          
          # Install dependencies
          npm ci
          
          # Generate Prisma
          npx prisma generate
          
          # Build
          npm run build
          
          # Run migrations
          DB_URL=$(railway variables get DATABASE_URL 2>/dev/null || echo "")
          if [ -n "$DB_URL" ]; then
            echo "üóÑÔ∏è Running database migrations..."
            DATABASE_URL="$DB_URL" npx prisma migrate deploy
          fi
          
          # Deploy
          echo "üöÄ Deploying to Railway..."
          railway up --detach
          
          echo "‚úÖ Deployment initiated"

      - name: Verify Deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üîç Verifying deployment..."
          
          cd backend
          
          # Wait for deployment
          sleep 30
          
          # Get domain
          DOMAIN=$(railway domain 2>/dev/null || echo "")
          if [ -z "$DOMAIN" ]; then
            echo "‚ùå Could not get domain"
            exit 1
          fi
          
          BASE_URL="https://$DOMAIN"
          
          # Test health endpoint
          echo "Testing health endpoint..."
          for i in 1 2 3 4 5; do
            sleep 10
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/health" 2>/dev/null || echo "000")
            if [ "$RESPONSE" = "200" ]; then
              echo "‚úÖ Health check PASSED (HTTP 200)"
              
              HEALTH_DATA=$(curl -s "$BASE_URL/health" 2>/dev/null || echo "")
              echo "   Response: $HEALTH_DATA"
              
              echo ""
              echo "========================================"
              echo "üéâ 100% WORKING STACK DEPLOYED!"
              echo "========================================"
              echo ""
              echo "üîó Application URL: $BASE_URL"
              echo "üìö API Docs: $BASE_URL/api/v1/docs"
              echo "üîç Health Check: $BASE_URL/health"
              echo ""
              echo "‚öôÔ∏è Automatic publishing: ENABLED"
              echo "‚è∞ Generation interval: Every 1 hour"
              echo "üì∫ YouTube publishing: ENABLED"
              echo ""
              echo "üìù Next steps:"
              echo "  1. Visit the dashboard: $BASE_URL/dashboard"
              echo "  2. Wait for first video (within 1 hour)"
              echo "  3. Check YouTube Studio for new videos"
              echo ""
              echo "üîß Monitor:"
              echo "  railway logs"
              echo ""
              exit 0
            fi
            echo "‚è≥ Attempt $i: HTTP $RESPONSE, retrying..."
          done
          
          echo "‚ùå Health check failed after 5 attempts"
          echo "Check logs: railway logs"
          exit 1

  verify-100-working:
    name: '100% Verification'
    runs-on: ubuntu-latest
    needs: setup-phase-6-deploy
    if: github.event.inputs.mode == 'verify' || success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Railway CLI
        run: npm install -g @railway/cli@latest

      - name: Run 100% Verification
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "üîç Running 100% verification..."
          
          cd backend
          
          DOMAIN=$(railway domain 2>/dev/null || echo "")
          if [ -z "$DOMAIN" ]; then
            echo "‚ùå Could not get domain"
            exit 1
          fi
          
          BASE_URL="https://$DOMAIN"
          
          CHECKS_PASSED=0
          CHECKS_TOTAL=10
          
          # Check 1: Health endpoint
          echo "1Ô∏è‚É£ Health endpoint..."
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/health")
          if [ "$HEALTH" = "200" ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED (HTTP $HEALTH)"
          fi
          
          # Check 2: API docs
          echo "2Ô∏è‚É£ API documentation..."
          DOCS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/api/v1/docs")
          if [ "$DOCS" = "200" ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED (HTTP $DOCS)"
          fi
          
          # Check 3: Database connection
          echo "3Ô∏è‚É£ Database connection..."
          DB_URL=$(railway variables get DATABASE_URL 2>/dev/null || echo "")
          if [ -n "$DB_URL" ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED"
          fi
          
          # Check 4: Redis connection
          echo "4Ô∏è‚É£ Redis connection..."
          REDIS_URL=$(railway variables get REDIS_URL 2>/dev/null || echo "")
          if [ -n "$REDIS_URL" ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED"
          fi
          
          # Check 5: JWT secrets
          echo "5Ô∏è‚É£ Security secrets..."
          JWT=$(railway variables get JWT_SECRET 2>/dev/null || echo "")
          if [ -n "$JWT" ] && [ ${#JWT} -ge 32 ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED"
          fi
          
          # Check 6: Auto-generation enabled
          echo "6Ô∏è‚É£ Auto-generation enabled..."
          AUTO=$(railway variables get ENABLE_AUTO_GENERATION 2>/dev/null || echo "")
          if [ "$AUTO" = "true" ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED"
          fi
          
          # Check 7: API keys
          echo "7Ô∏è‚É£ API keys configured..."
          NEWS=$(railway variables get NEWS_API_KEY 2>/dev/null || echo "")
          OPENAI=$(railway variables get OPENAI_API_KEY 2>/dev/null || echo "")
          if [ -n "$NEWS" ] && [ -n "$OPENAI" ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED"
          fi
          
          # Check 8: YouTube credentials
          echo "8Ô∏è‚É£ YouTube credentials..."
          YT_CLIENT=$(railway variables get YOUTUBE_CLIENT_ID 2>/dev/null || echo "")
          YT_SECRET=$(railway variables get YOUTUBE_CLIENT_SECRET 2>/dev/null || echo "")
          YT_TOKEN=$(railway variables get YOUTUBE_REFRESH_TOKEN 2>/dev/null || echo "")
          if [ -n "$YT_CLIENT" ] && [ -n "$YT_SECRET" ] && [ -n "$YT_TOKEN" ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED"
          fi
          
          # Check 9: Video generation
          echo "9Ô∏è‚É£ Video generation service..."
          LUMA=$(railway variables get LUMA_API_KEY 2>/dev/null || echo "")
          RUNWAY=$(railway variables get RUNWAY_API_KEY 2>/dev/null || echo "")
          if [ -n "$LUMA" ] || [ -n "$RUNWAY" ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED"
          fi
          
          # Check 10: Production mode
          echo "üîü Production mode..."
          NODE_ENV=$(railway variables get NODE_ENV 2>/dev/null || echo "")
          if [ "$NODE_ENV" = "production" ]; then
            echo "   ‚úÖ PASSED"
            CHECKS_PASSED=$((CHECKS_PASSED + 1))
          else
            echo "   ‚ùå FAILED"
          fi
          
          echo ""
          echo "========================================"
          echo "üìä VERIFICATION RESULTS"
          echo "========================================"
          echo "Passed: $CHECKS_PASSED / $CHECKS_TOTAL"
          echo ""
          
          if [ $CHECKS_PASSED -eq $CHECKS_TOTAL ]; then
            echo "üéâ 100% WORKING! All checks passed!"
            echo ""
            echo "‚úÖ Automatic video publishing is fully configured"
            echo "‚úÖ Videos will generate every hour"
            echo "‚úÖ Videos will auto-publish to YouTube"
            exit 0
          else
            echo "‚ö†Ô∏è Some checks failed ($((CHECKS_TOTAL - CHECKS_PASSED)) issues)"
            echo ""
            echo "Run fixes:"
            echo "  gh workflow run 100-working-stack.yml -f mode=fix"
            exit 1
          fi

  summary:
    name: 'Deployment Summary'
    runs-on: ubuntu-latest
    needs: [setup-phase-6-deploy, verify-100-working]
    if: always()
    steps:
      - name: Final Summary
        run: |
          echo ""
          echo "========================================"
          echo "üéØ DEPLOYMENT COMPLETE"
          echo "========================================"
          echo ""
          echo "Mode: ${{ github.event.inputs.mode }}"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo ""
          echo "Infrastructure: ${{ needs.setup-phase-1-infrastructure.result }}"
          echo "Security: ${{ needs.setup-phase-2-security.result }}"
          echo "API Keys: ${{ needs.setup-phase-3-api-keys.result }}"
          echo "YouTube: ${{ needs.setup-phase-4-youtube.result }}"
          echo "Automation: ${{ needs.setup-phase-5-automation.result }}"
          echo "Deploy: ${{ needs.setup-phase-6-deploy.result }}"
          echo "Verification: ${{ needs.verify-100-working.result }}"
          echo ""
          
          if [ "${{ needs.verify-100-working.result }}" = "success" ]; then
            echo "‚úÖ STACK IS 100% WORKING!"
            echo ""
            echo "üé¨ Automatic video generation is active"
            echo "‚è∞ Next video will be generated within 1 hour"
          else
            echo "‚ö†Ô∏è Some issues remain. Check logs above."
          fi
