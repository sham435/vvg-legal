version: '3.8'

# Docker Compose with Secret Management
# Usage: docker-compose -f docker-compose.secrets.yml up -d

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: vvg-backend
    environment:
      - NODE_ENV=production
      - PORT=3000
      - FRONTEND_URL=http://localhost:5173
      # Secrets are mounted as files, not env vars
      - JWT_SECRET_FILE=/run/secrets/jwt_secret
      - DATABASE_URL_FILE=/run/secrets/database_url
      - REDIS_URL_FILE=/run/secrets/redis_url
      # API Keys
      - NEWS_API_KEY_FILE=/run/secrets/news_api_key
      - OPENAI_API_KEY_FILE=/run/secrets/openai_api_key
      - OPENROUTER_API_KEY_FILE=/run/secrets/openrouter_api_key
      # Social Media
      - YOUTUBE_CLIENT_ID_FILE=/run/secrets/youtube_client_id
      - YOUTUBE_CLIENT_SECRET_FILE=/run/secrets/youtube_client_secret
      - YOUTUBE_REFRESH_TOKEN_FILE=/run/secrets/youtube_refresh_token
      - TIKTOK_CLIENT_KEY_FILE=/run/secrets/tiktok_client_key
      - TIKTOK_CLIENT_SECRET_FILE=/run/secrets/tiktok_client_secret
      - INSTAGRAM_ACCESS_TOKEN_FILE=/run/secrets/instagram_access_token
      # Other
      - DISCORD_WEBHOOK_URL_FILE=/run/secrets/discord_webhook_url
    secrets:
      - jwt_secret
      - database_url
      - redis_url
      - news_api_key
      - openai_api_key
      - openrouter_api_key
      - youtube_client_id
      - youtube_client_secret
      - youtube_refresh_token
      - tiktok_client_key
      - tiktok_client_secret
      - instagram_access_token
      - discord_webhook_url
    ports:
      - "3000:3000"
    networks:
      - vvg-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  postgres:
    image: postgres:16-alpine
    container_name: vvg-postgres
    environment:
      POSTGRES_DB: viral_video_db
      POSTGRES_USER: vvg_user
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - vvg-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: vvg-redis
    volumes:
      - redis-data:/data
    networks:
      - vvg-network
    restart: unless-stopped
    command: redis-server --appendonly yes

networks:
  vvg-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:

# Docker Secrets Definition
# Create secrets using: echo "your-secret" | docker secret create jwt_secret -
secrets:
  jwt_secret:
    external: true
  database_url:
    external: true
  redis_url:
    external: true
  postgres_password:
    external: true
  news_api_key:
    external: true
  openai_api_key:
    external: true
  openrouter_api_key:
    external: true
  youtube_client_id:
    external: true
  youtube_client_secret:
    external: true
  youtube_refresh_token:
    external: true
  tiktok_client_key:
    external: true
  tiktok_client_secret:
    external: true
  instagram_access_token:
    external: true
  discord_webhook_url:
    external: true
